/*!
 * marvel-quiz v0.1.0 [https://github.com/redaemn/marvel-quiz]
 * 2014-04-10
 *
 * This software is licensed under The MIT License (MIT)
 * Copyright (c) 2014 Gabriele Rabbiosi [https://plus.google.com/+GabrieleRabbiosi/]
 * [https://github.com/redaemn/marvel-quiz/blob/master/LICENSE]
 */
"use strict";angular.module("marvelQuizApp",["marvelQuizApp.common","marvelQuizApp.quizzes","ngRoute","timer"]).config(["$routeProvider","$httpProvider","MarvelWrapperProvider",function(a,b,c){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl"}).when("/options",{templateUrl:"views/options.html",controller:"OptionsCtrl"}).otherwise({redirectTo:"/"}),c.setApiKey("fad24ca2acf5adc8c2e73d2ad1a8b06a"),b.interceptors.push("MarvelApiLimitExceededInterceptor")}]).run(["$rootScope","MarvelApiStatus","APP_STATE_EVENTS",function(a,b,c){a.$on("$locationChangeStart",function(d,e){var f=e.indexOf("/quiz/")>-1;f&&b.apiLimitExceeded()&&(d.preventDefault(),a.$broadcast(c.marvelApiLimitExceeded))})}]),angular.module("marvelQuizApp.common",["ngRoute"]),angular.module("marvelQuizApp.quizzes",["marvelQuizApp.common"]),angular.module("marvelQuizApp").controller("HomeCtrl",["$scope","GoogleAnalytics",function(a,b){b.pageView()}]),angular.module("marvelQuizApp").controller("NavbarCtrl",["$scope","Quiz","$location","Score",function(a,b,c,d){a.quizzes=b.getAllQuizzes(),a.isActive=function(a){return c.path()===a},a.currentPoints=d.currentPoints}]),angular.module("marvelQuizApp").controller("MainCtrl",["$scope","QUIZ_EVENTS","Score","APP_STATE_EVENTS",function(a,b,c,d){a.$on(b.quizStart,function(a,b){c.registerAttemptedQuiz(b.quizName)}),a.$on(b.correctAnswer,function(a,b){c.registerCorrectAnswer(b)}),a.$on(b.wrongAnswer,function(a,b){c.registerWrongAnswer(b.quizName)}),a.$on(d.marvelApiLimitExceeded,function(){a.marvelApiLimitExceeded=!0})}]),angular.module("marvelQuizApp").controller("OptionsCtrl",["$scope","Score","$window","GoogleAnalytics",function(a,b,c,d){d.pageView(),a.resetScore=function(){c.confirm("Are you sure you want to delete all your prestige and start from scratch?")&&b.resetScore()}}]),angular.module("marvelQuizApp.common").provider("Quiz",["$routeProvider",function(a){function b(a){return a.replace(/^mq\./,"")}function c(a,b){return void 0===b&&(b=" "),a.replace(/[A-Z]/g,function(a){return b+a.toLowerCase()})}function d(a){return a.replace(/^([a-z])|\s+([a-z])/g,function(a){return a.toUpperCase()})}function e(a){return"/quiz/"+c(b(a),"-")}function f(a){return a.displayName?a.displayName:d(c(b(a.uniqueName)))}var g={},h={uniqueName:"",controller:"",templateUrl:""};this.register=function(b){if(b=angular.extend({},h,b),0!==b.uniqueName.indexOf("mq."))throw new Error('Quiz unique name "'+b.uniqueName+'" must start with "mq." prefix');if(g[b.uniqueName])throw new Error('Quiz "'+b.uniqueName+'" already registered.');g[b.uniqueName]={displayName:f(b),route:e(b.uniqueName)},a.when(g[b.uniqueName].route,{templateUrl:"quizzes/"+b.templateUrl,controller:b.controller})},this.$get=function(){function a(){return null===b&&(b=angular.copy(g)),b}var b=null;return{getAllQuizzes:a}}}]),angular.module("marvelQuizApp.common").provider("MarvelWrapper",function(){var a;this.setApiKey=function(b){a=b},this.$get=["$http","Cache","$q","GoogleAnalytics","MarvelApiStatus",function(b,c,d,e,f){function g(a){var b=d.defer();return b.resolve(a),b.promise}function h(a){var b="";return 429===a.status?(e.marvelServiceLimitExceeded(),f.apiLimitExceeded(!0)):0===a.status?e.marvelServiceError("0 - Aborted"):(b+=a.status,a.data.code&&(b+=" - "+a.data.code),a.data.message&&(b+=" - "+a.data.message),e.marvelServiceError(b)),d.reject(a)}function i(){var d="totalCharacters",f=c.get(d);return f?(e.marvelServiceCacheHit("characters"),g(f)):b.get(k+"/characters",{params:{limit:1,apikey:a}}).then(function(a){var b=a.data.data.total;return c.put(d,b),e.marvelServiceRequest("characters"),b},h)}function j(d){var f="characters/"+angular.toJson(d),i=c.get(f);return i?(e.marvelServiceCacheHit("characters"),g(i)):b.get(k+"/characters",{params:angular.extend(d,{apikey:a})}).then(function(a){var b=a.data.data.results;return c.put(f,b),e.marvelServiceRequest("characters"),b},h)}var k="//gateway.marvel.com/v1/public";return{totalCharacters:i,characters:j}}]}),angular.module("marvelQuizApp.common").service("MarvelData",["MarvelWrapper","$q","Utils",function(a,b,c){function d(c){if(c=angular.extend({},k,c),c.count<1||c.count>100)throw new Error("MarvelData[getRandomCharacter()]: Count param must be between 1 and 100");return a.totalCharacters().then(function(a){var d,e=[];for(d=0;d<c.count;++d)e.push(c.withImageAvailable?g(a):f(a));return b.all(e)})}function e(b){return a.characters({limit:j,offset:j*(b-1)})}function f(a){var b,d;return 0>l&&(i=c.getRandomArray(0,a-1),l=a-1),b=i[l--],d=Math.ceil((b+1)/j),e(d).then(function(a){return a[b%j]})}function g(a){return f(a).then(function(b){return h(b)?b:g(a)})}function h(a){var b=/^.+\/image_not_available$/;return!b.test(a.thumbnail.path)}var i,j=10,k={count:1,withImageAvailable:!1},l=-1;this.getRandomCharacter=d}]),angular.module("marvelQuizApp.common").service("Cache",["$window",function(a){function b(a,b,c){this.data=a,this.created=b?new Date(b):new Date,c&&(this.expiration=c)}function c(){var a,c;return i&&(a=i.getItem("MarvelQuizApp"))?(c={},angular.forEach(angular.fromJson(a),function(a,d){var e=new b(a.data,a.created,a.expiration);e.isExpired()||(c[d]=e)}),c):{}}function d(a){i&&i.setItem("MarvelQuizApp",angular.toJson(a))}function e(a,c,d){h[a]=angular.isDefined(d)?new b(c,null,d):new b(c)}function f(a){return h[a]?h[a].isExpired()?(delete h[a],g):h[a].data:g}var g,h,i=a.localStorage||null;b.prototype.isExpired=function(){var a=new Date;return-1===this.expiration?!1:a-this.created>(this.expiration||864e5)},h=c(),angular.element(a).on("unload",function(){d(h)}),this.put=e,this.get=f}]),angular.module("marvelQuizApp.common").service("GoogleAnalytics",["$window","$location",function(a,b){function c(){j("send","pageview",b.path())}function d(){j("send","event","marvel-link","click",b.path())}function e(a){j("send","event","marvel-service","request",a)}function f(a){j("send","event","marvel-service","cache-hit",a)}function g(a){j("send","event","marvel-service","error-response",a)}function h(){j("send","event","marvel-service","limit-exceeded")}function i(a){j("send","event","feature-usage",a)}var j=angular.isFunction(a.ga)?a.ga:angular.noop;this.pageView=c,this.marvelLinkClick=d,this.marvelServiceRequest=e,this.marvelServiceCacheHit=f,this.marvelServiceError=g,this.marvelServiceLimitExceeded=h,this.featureUsage=i}]),angular.module("marvelQuizApp.common").constant("QUIZ_EVENTS",{quizStart:"quiz-event-start",correctAnswer:"quiz-event-correct-answer",wrongAnswer:"quiz-event-wrong-answer"}),angular.module("marvelQuizApp").service("Score",["Cache",function(a){function b(){return{version:p,attemptedQuizzes:{},correctAnswers:{},wrongAnswers:{},points:{}}}function c(a){return angular.isUndefined(a.version)&&(a.version=1),1===a.version&&(a.version=2,a.points={}),a}function d(){a.put("scoreValues",o,-1)}function e(a){return a&&o.attemptedQuizzes[a]?o.attemptedQuizzes[a]:f()}function f(){var a=0;return angular.forEach(o.attemptedQuizzes,function(b){a+=b}),a}function g(a){if(!angular.isString(a))throw new Error("Score[registerAttemptedQuiz()]: quizName parameter is not valid");return o.attemptedQuizzes[a]=(o.attemptedQuizzes[a]||0)+1,d(),o.attemptedQuizzes[a]}function h(a){var b=a.quizName;if(!angular.isString(b))throw new Error("Score[registerCorrectAnswer()]: quizName parameter is not valid");return o.correctAnswers[b]=(o.correctAnswers[b]||0)+1,o.points[b]=(o.points[b]||0)+(a.points||0),d(),o.correctAnswers[b]}function i(){var a=0;return angular.forEach(o.correctAnswers,function(b){a+=b}),a}function j(){var a=0;return angular.forEach(o.points,function(b){a+=b}),a}function k(a){if(!angular.isString(a))throw new Error("Score[registerWrongAnswer()]: quizName parameter is not valid");return o.wrongAnswers[a]=(o.wrongAnswers[a]||0)+1,d(),o.wrongAnswers[a]}function l(a){var b,c,d;return a?(c=o.attemptedQuizzes[a]||0,d=o.correctAnswers[a]||0):(c=f(),d=i()),b=0!==c?d/c:0,(100*b).toFixed(2)}function m(a){return a?o.points[a]||0:j()}function n(){o=b(),d()}var o,p=2;o=a.get("scoreValues")||b(),o.version!==p&&(c(o),d()),this.getAttemptedQuizzes=e,this.registerAttemptedQuiz=g,this.registerCorrectAnswer=h,this.registerWrongAnswer=k,this.successRate=l,this.currentPoints=m,this.resetScore=n}]),angular.module("marvelQuizApp.common").service("MarvelApiLimitExceededInterceptor",["$q","MarvelApiStatus","$rootScope","APP_STATE_EVENTS",function(a,b,c,d){function e(a){return a.url.indexOf("/gateway.marvel.com/")>-1}return{request:function(f){var g=a.defer();return f.timeout=g.promise,e(f)&&b.apiLimitExceeded()&&(g.resolve(),c.$broadcast(d.marvelApiLimitExceeded)),f||a.when(f)}}}]),angular.module("marvelQuizApp").service("MarvelApiStatus",["Cache",function(a){function b(b){return angular.isDefined(b)&&(c=b,a.put("apiLimitExceeded",c,18e5)),c}var c=a.get("apiLimitExceeded")||!1;this.apiLimitExceeded=b}]),angular.module("marvelQuizApp.common").constant("APP_STATE_EVENTS",{marvelApiLimitExceeded:"app-state-event-marvel-api-limit-exceeded"}),angular.module("marvelQuizApp.common").service("Utils",function(){function a(a,b){return Math.floor(Math.random()*(b-a+1))+a}function b(a,b){var d,e=[];for(d=a;b>=d;d++)e.push(d);return c(e)}function c(a){for(var b,c,d=a.length;0!==d;)c=Math.floor(Math.random()*d),d-=1,b=a[d],a[d]=a[c],a[c]=b;return a}this.getRandomInt=a,this.getRandomArray=b,this.shuffleArray=c}),angular.module("marvelQuizApp").directive("marvelLink",["GoogleAnalytics",function(a){function b(){a.marvelLinkClick()}return{template:'<a class="marvel-link" ng-href="{{url}}" ng-transclude target="_blank"></a>',replace:!0,transclude:!0,scope:{url:"@"},restrict:"E",link:function(a,c){c.on("click",b)}}}]),angular.module("marvelQuizApp").directive("marvelApiLimitExceededModal",function(){return{restrict:"E",templateUrl:"views/common/marvel-api-limit-exceeded-modal.html",replace:!0,scope:{toggle:"="},link:function(a,b){a.$watch("toggle",function(a){b.modal(a===!0?"show":"hide")})}}}),angular.module("marvelQuizApp").directive("onLoad",function(){return{restrict:"A",scope:{onLoad:"&"},link:function(a,b){b.on("load",function(){a.onLoad(),a.$apply()})}}}),angular.module("marvelQuizApp.quizzes").config(["QuizProvider",function(a){a.register({uniqueName:"mq.nameTheImage",displayName:"Who are you?",controller:"mq.nameTheImage.MainCtrl",templateUrl:"nameTheImage/views/main.html"})}]),angular.module("marvelQuizApp.quizzes").controller("mq.nameTheImage.MainCtrl",["$scope","MarvelData","QUIZ_EVENTS","GoogleAnalytics","Utils",function(a,b,c,d,e){function f(){d.pageView(),a.showIntro=!1,a.characters=[],a.namesChoices=[],a.selectedName=null,a.answered=!1,a.timeout=!1,a.progressWidth=100,a.loadingCharacters=!0,a.loadingError=!1,h=[],b.getRandomCharacter({count:3,withImageAvailable:!0}).then(function(b){angular.forEach(b,function(b){a.characters.push({image:b.thumbnail,name:"",urls:b.urls}),a.namesChoices.push(b.name),h.push(b.name)}),e.shuffleArray(a.namesChoices),a.$emit(c.quizStart,{quizName:j})},function(){a.loadingCharacters=!1,a.loadingError=!0})}function g(a,b,c){var d;return d=b>=a?10:a>6e3?0:a>=c?1:10-Math.ceil((a-b)/Math.ceil((c-b)/8))}var h,i,j="nameTheImage";a.showIntro=!0,a.startQuiz=f,a.answerSelected=function(){a.timeout||(a.answered=!0,a.$broadcast("timer-stop"))},a.$watch("selectedName",function(b,d){b!==d&&null!==b&&(a.selectedName===h[0]?(a.correctAnswer=!0,a.$emit(c.correctAnswer,{quizName:j,points:g(i,2e3,4e3)})):(a.correctAnswer=!1,a.$emit(c.wrongAnswer,{quizName:j})),angular.forEach(h,function(b,c){a.characters[c].name=b}))}),a.$on("timer-stopped",function(b,c){i=c.millis,a.answered||(a.timeout=!0,a.selectedName="_obviously_wrong_",a.$apply())}),a.$on("timer-tick",function(b,c){a.progressWidth=100*(600-Math.ceil(c.millis/10))/600,c.millis>=6e3&&a.$broadcast("timer-stop")}),a.onQuizImageLoaded=function(){a.$broadcast("timer-start"),a.loadingCharacters=!1}}]),angular.module("marvelQuizApp.quizzes").directive("characterCard",function(){return{templateUrl:"quizzes/nameTheImage/views/character-card.html",replace:!0,scope:{character:"="},restrict:"E"}}),angular.module("marvelQuizApp.quizzes").directive("cardsSlider",["$timeout","$window","GoogleAnalytics",function(a,b,c){return{scope:{refresh:"="},restrict:"A",link:function(d,e){var f=new b.IScroll(e[0],{eventPassthrough:!0,scrollX:!0,scrollY:!1});f.on("scrollStart",function(){c.featureUsage("cards slider scrolling")}),d.$watch("refresh",function(){a(function(){f.refresh()},0)})}}}]);