"use strict";angular.module("marvelQuizApp",["marvelQuizApp.common","marvelQuizApp.quizzes","ngRoute"]).config(["$routeProvider","MarvelWrapperProvider",function(a,b){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl"}).otherwise({redirectTo:"/"}),b.setApiKey("fad24ca2acf5adc8c2e73d2ad1a8b06a")}]),angular.module("marvelQuizApp.common",["ngRoute"]),angular.module("marvelQuizApp.quizzes",["marvelQuizApp.common"]),angular.module("marvelQuizApp").controller("HomeCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("marvelQuizApp").controller("NavbarCtrl",["$scope","Quiz","$location",function(a,b,c){a.quizzes=b.getAllQuizzes(),a.isActive=function(a){return c.path()===a}}]),angular.module("marvelQuizApp").controller("MainCtrl",["$scope","QUIZ_EVENTS","Score",function(a,b,c){a.attemptedQuizzes=c.getAttemptedQuizzes(),a.successRate=c.successRate(),a.$on(b.quizStart,function(b,d){a.attemptedQuizzes=c.registerAttemptedQuiz(d),a.successRate=c.successRate()}),a.$on(b.correctAnswer,function(b,d){c.registerCorrectAnswer(d),a.successRate=c.successRate()}),a.$on(b.wrongAnswer,function(b,d){c.registerWrongAnswer(d),a.successRate=c.successRate()})}]),angular.module("marvelQuizApp.common").provider("Quiz",["$routeProvider",function(a){function b(a){return a.replace(/^mq\./,"")}function c(a,b){return void 0===b&&(b=" "),a.replace(/[A-Z]/g,function(a){return b+a.toLowerCase()})}function d(a){return a.replace(/^([a-z])|\s+([a-z])/g,function(a){return a.toUpperCase()})}function e(a){return"/quiz/"+c(b(a),"-")}function f(a){return d(c(b(a)))}var g={},h={quizName:"",controller:"",templateUrl:""};this.register=function(b){if(b=angular.extend({},h,b),0!==b.quizName.indexOf("mq."))throw new Error('Quiz name "'+b.quizName+'" must start with "mq." prefix');if(g[b.quizName])throw new Error('Quiz "'+b.quizName+'" already registered.');g[b.quizName]={displayName:f(b.quizName),route:e(b.quizName)},a.when(g[b.quizName].route,{templateUrl:"quizzes/"+b.templateUrl,controller:b.controller})},this.$get=function(){function a(){return null===b&&(b=angular.copy(g)),b}var b=null;return{getAllQuizzes:a}}}]),angular.module("marvelQuizApp.common").provider("MarvelWrapper",function(){var a;this.setApiKey=function(b){a=b},this.$get=["$http","Cache","$q","GoogleAnalytics",function(b,c,d,e){function f(a){var b=d.defer();return b.resolve(a),b.promise}function g(a){429===a.status?e.marvelServiceLimitExceeded():e.marvelServiceError(""+a.status+" - "+a.data)}function h(){var d="totalCharacters",h=c.get(d);return h?f(h):b.get(j+"/characters",{params:{limit:1,apikey:a}}).then(function(a){var b=a.data.data.total;return c.put(d,b),e.marvelServiceRequest("characters"),b},g)}function i(d){var h="characters/"+angular.toJson(d),i=c.get(h);return i?f(i):b.get(j+"/characters",{params:angular.extend(d,{apikey:a})}).then(function(a){var b=a.data.data.results;return c.put(h,b),e.marvelServiceRequest("characters"),b},g)}var j="//gateway.marvel.com/v1/public";return{totalCharacters:h,characters:i}}]}),angular.module("marvelQuizApp.common").service("MarvelData",["MarvelWrapper","$q",function(a,b){function c(c){if(c=angular.extend({},j,c),c.count<1||c.count>100)throw new Error("MarvelData[getRandomCharacter()]: Count param must be between 1 and 100");return a.totalCharacters().then(function(a){var d,g=[];for(d=0;d<c.count;++d)g.push(c.withImageAvailable?f(a):e(a));return b.all(g)})}function d(b){return a.characters({limit:i,offset:i*(b-1)})}function e(a){var b=h(0,a-1),c=Math.ceil((b+1)/i);return d(c).then(function(a){return a[b%i]})}function f(a){return e(a).then(function(b){return g(b)?b:f(a)})}function g(a){var b=/^.+\/image_not_available$/;return!b.test(a.thumbnail.path)}function h(a,b){return Math.floor(Math.random()*(b-a+1))+a}var i=10,j={count:1,withImageAvailable:!1};this.getRandomCharacter=c}]),angular.module("marvelQuizApp.common").service("Cache",["$window",function(a){function b(a,b,c){this.data=a,this.created=b?new Date(b):new Date,c&&(this.expiration=c)}function c(){var a,c;return i&&(a=i.getItem("MarvelQuizApp"))?(c={},angular.forEach(angular.fromJson(a),function(a,d){var e=new b(a.data,a.created,a.expiration);e.isExpired()||(c[d]=e)}),c):{}}function d(a){i&&i.setItem("MarvelQuizApp",angular.toJson(a))}function e(a,c,d){h[a]=angular.isDefined(d)?new b(c,null,d):new b(c)}function f(a){return h[a]?h[a].isExpired()?(delete h[a],g):h[a].data:g}var g,h,i=a.localStorage||null;b.prototype.isExpired=function(){var a=new Date;return-1===this.expiration?!1:a-this.created>(this.expiration||864e5)},h=c(),angular.element(a).on("unload",function(){d(h)}),this.put=e,this.get=f}]),angular.module("marvelQuizApp.common").service("GoogleAnalytics",["$window",function(a){function b(){g("send","pageview")}function c(){g("send","event","button","click","marvel-link")}function d(a){g("send","event","marvel-service","request",a)}function e(a){g("send","event","marvel-service","error-response",a)}function f(){g("send","event","marvel-service","limit-exceeded")}var g=angular.isFunction(a.ga)?a.ga:angular.noop;this.pageView=b,this.marvelLinkClick=c,this.marvelServiceRequest=d,this.marvelServiceError=e,this.marvelServiceLimitExceeded=f}]),angular.module("marvelQuizApp.common").constant("QUIZ_EVENTS",{quizStart:"quiz-event-start",correctAnswer:"quiz-event-correct-answer",wrongAnswer:"quiz-event-wrong-answer"}),angular.module("marvelQuizApp").service("Score",["Cache",function(a){function b(){a.put("scoreValues",h,-1)}function c(){return h.attemptedQuizzes}function d(){var a=++h.attemptedQuizzes;return b(),a}function e(){var a=++h.correctAnswers;return b(),a}function f(){var a=++h.wrongAnswers;return b(),a}function g(){var a;return a=0!==h.attemptedQuizzes?h.correctAnswers/h.attemptedQuizzes:0,(100*a).toFixed(2)}var h=a.get("scoreValues")||{attemptedQuizzes:0,correctAnswers:0,wrongAnswers:0};this.getAttemptedQuizzes=c,this.registerAttemptedQuiz=d,this.registerCorrectAnswer=e,this.registerWrongAnswer=f,this.successRate=g}]),angular.module("marvelQuizApp").directive("marvelLink",["GoogleAnalytics",function(a){function b(){a.marvelLinkClick()}return{template:'<a class="marvel-link" ng-href="{{url}}" ng-transclude target="_blank"></a>',replace:!0,transclude:!0,scope:{url:"@"},restrict:"E",link:function(a,c){c.on("click",b)}}}]),angular.module("marvelQuizApp.quizzes").config(["QuizProvider",function(a){a.register({quizName:"mq.matchCharacters",controller:"mq.matchCharacters.MainCtrl",templateUrl:"matchCharacters/views/main.html"})}]),angular.module("marvelQuizApp.quizzes").controller("mq.matchCharacters.MainCtrl",["$scope","MarvelData","QUIZ_EVENTS",function(a,b,c){function d(){a.characters=[],a.correctNames=[],a.chosenNames=[],a.answered=!1,a.correctAnswer=!1,f=null,a.loadingCharacters=!0,b.getRandomCharacter({count:4,withImageAvailable:!0}).then(function(b){angular.forEach(b,function(b){a.characters.push({image:b.thumbnail,name:b.name,urls:b.urls}),a.chosenNames.push(b.name)}),e(a.chosenNames),a.loadingCharacters=!1,a.$emit(c.quizStart,{quizName:"matchCharacters"})})}function e(a){for(var b,c,d=a.length;0!==d;)c=Math.floor(Math.random()*d),d-=1,b=a[d],a[d]=a[c],a[c]=b;return a}var f;d(),a.restart=d,a.selectName=function(b){var c;a.answered||(null!==f?(f!==b&&(c=a.chosenNames[f],a.chosenNames[f]=a.chosenNames[b],a.chosenNames[b]=c),f=null):f=b)},a.isNameSelected=function(a){return a===f},a.checkAnswer=function(){var b=!0;a.answered=!0,angular.forEach(a.chosenNames,function(c,d){a.characters[d].name!==c&&(b=!1)}),a.correctAnswer=b,b?a.$emit(c.correctAnswer,{quizName:"matchCharacters"}):a.$emit(c.wrongAnswer,{quizName:"matchCharacters"})},a.isNameCorrect=function(b){return a.chosenNames[b]===a.characters[b].name},a.showSolution=function(){angular.forEach(a.characters,function(b){a.correctNames.push(b.name)})}}]);